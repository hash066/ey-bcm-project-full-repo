openapi: 3.0.3
info:
  title: BIA Module API
  version: 1.0.0
  description: |
    OpenAPI spec for the Business Impact Analysis (BIA) module (subset of endpoints).

    **Database Migration Notice:**
    This API has been migrated to use Supabase as the primary database with PostgreSQL as fallback.
    All endpoints now prioritize Supabase operations for improved performance and scalability.
servers:
  - url: http://localhost:8000
    description: Local development server
paths:
  /bia/overview:
    get:
      summary: Get BIA overview
      parameters:
        - name: organization_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: BIA overview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BIAOverviewResponse'
  /bia/processes:
    post:
      summary: Get processes for BIA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BIAProcessRequest'
      responses:
        '200':
          description: List of processes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProcessItem'
  /bia/process-info:
    post:
      summary: Create process BIA info
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BIAProcessInfoCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BIAProcessInfo'
  /bia/process-info/{bia_info_id}:
    put:
      summary: Update process BIA info
      parameters:
        - name: bia_info_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BIAProcessInfoUpdate'
      responses:
        '200':
          description: Updated
  /bia/bulk-update:
    post:
      summary: Bulk update process BIA info
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                organization_id:
                  type: string
                  format: uuid
                department_name:
                  type: string
                subdepartment_name:
                  type: string
                processes:
                  type: array
                  items:
                    type: object
      responses:
        '200':
          description: Bulk update result
  /bia/impact-analysis:
    post:
      summary: Create impact analysis
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessImpactAnalysisCreate'
      responses:
        '201':
          description: Created
  /bia/impact-analysis/{impact_analysis_id}:
    put:
      summary: Update impact analysis
      parameters:
        - name: impact_analysis_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessImpactAnalysisUpdate'
      responses:
        '200':
          description: Updated
  /bia/impact-analysis/process/{process_id}:
    get:
      summary: Get process impact analysis
      parameters:
        - name: process_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Impact analysis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessImpactAnalysisResponse'
  /bia/impact-analysis/bulk:
    post:
      summary: Bulk create/update impact analysis
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                processes:
                  type: array
                  items:
                    $ref: '#/components/schemas/ProcessImpactAnalysisItem'
      responses:
        '200':
          description: Bulk result
  /bia/organization/{organization_id}/processes:
    get:
      summary: Get organization processes
      parameters:
        - name: organization_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List
  /bia/impact-analysis/organization/{organization_id}:
    get:
      summary: Get organization impact analysis
      parameters:
        - name: organization_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List
  /bia/heatmap/{organization_id}:
    get:
      summary: Get heatmap data
      parameters:
        - name: organization_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Heatmap data
  /bia/dependencies/{organization_id}:
    get:
      summary: Get dependency graph
      parameters:
        - name: organization_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Dependencies
  /bia/alerts/{organization_id}:
    get:
      summary: Get alerts and mitigations
      parameters:
        - name: organization_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Alerts
  /bia/mitigation-task/{task_id}/complete:
    post:
      summary: Complete mitigation task
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Completed
  /bia/save-bia-info:
    post:
      summary: Save BIA snapshot (encrypted)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                organization_id:
                  type: string
                  format: uuid
                data:
                  type: object
                source:
                  type: string
                notes:
                  type: string
      responses:
        '200':
          description: Snapshot saved
components:
  schemas:
    BIAOverviewResponse:
      type: object
      properties:
        totalFunctions:
          type: integer
        criticalFunctions:
          type: integer
        priorities:
          type: object
          additionalProperties:
            type: integer
        heatmapCells:
          type: array
          items:
            $ref: '#/components/schemas/BIAHeatmapCell'
        mitigations:
          type: array
          items:
            type: object
        dependencies:
          type: array
          items:
            type: object
    BIAHeatmapCell:
      type: object
      properties:
        functionAId:
          type: string
        functionBId:
          type: string
        riskScore:
          type: number
        impact:
          type: number
        likelihood:
          type: number
    BIAProcessRequest:
      type: object
      properties:
        organization_id:
          type: string
          format: uuid
        department_name:
          type: string
        subdepartment_name:
          type: string
    ProcessItem:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        has_bia_info:
          type: boolean
    BIAProcessInfoCreate:
      type: object
      properties:
        process_id:
          type: string
        description:
          type: string
        peak_period:
          type: string
        spoc:
          type: string
        review_status:
          type: string
    BIAProcessInfo:
      type: object
      properties:
        id:
          type: string
        process_id:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
    ProcessImpactAnalysisCreate:
      type: object
      properties:
        process_id:
          type: string
        rto:
          type: string
        rpo:
          type: string
        mtpd:
          type: string
        impact_data:
          type: object
        is_critical:
          type: boolean
    ProcessImpactAnalysisResponse:
      type: object
      properties:
        id:
          type: string
        process_id:
          type: string
        rto:
          type: string
        mtpd:
          type: string
        is_critical:
          type: boolean
    ProcessImpactAnalysisItem:
      type: object
      properties:
        process_id:
          type: string
        rto:
          type: string
        is_critical:
          type: boolean
